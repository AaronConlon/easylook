name: Build Frontend and Deploy

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
    types:
      - closed

jobs:
  build-and-deploy:
    # åªåœ¨æ¨é€åˆ° main åˆ†æ”¯æˆ–è€… PR åˆå¹¶åˆ° main åˆ†æ”¯æ—¶è¿è¡Œ
    if: github.ref == 'refs/heads/main' || (github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main')
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'yarn'
          cache-dependency-path: 'packages/app-website/yarn.lock'

      - name: å®‰è£…ä¾èµ–
        run: |
          cd packages/app-website
          yarn install --frozen-lockfile

      - name: æ„å»ºå‰ç«¯é¡¹ç›®
        run: |
          cd packages/app-website
          yarn build

      - name: éªŒè¯æ„å»ºäº§ç‰©
        run: |
          if [ ! -d "./packages/app-website/build" ]; then
            echo "æ„å»ºå¤±è´¥ï¼šæ‰¾ä¸åˆ° build ç›®å½•"
            exit 1
          fi
          echo "æ„å»ºæˆåŠŸï¼Œäº§ç‰©å¤§å°ï¼š"
          du -sh ./packages/app-website/build

      - name: å‹ç¼©æ„å»ºäº§ç‰©
        run: |
          cd packages/app-website
          zip -r build.zip build/
          echo "âœ… æ„å»ºäº§ç‰©å·²å‹ç¼©"
          echo "å‹ç¼©æ–‡ä»¶å¤§å°ï¼š"
          ls -lh build.zip

      - name: æ¨é€æ„å»ºäº§ç‰©åˆ°è¿œç¨‹æœåŠ¡å™¨
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          source: './packages/app-website/build.zip'
          target: '${{ secrets.REMOTE_TARGET_PATH }}'
          overwrite: true

      - name: åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šéƒ¨ç½²
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22 
          script: |
            cd ${{ secrets.REMOTE_TARGET_PATH }}

            echo "ğŸ“¦ è§£å‹æ„å»ºäº§ç‰©..."
            # åˆ é™¤æ—§çš„ build ç›®å½•
            rm -rf build
            unzip -o build.zip

            echo "ğŸ³ æ‰§è¡Œ Docker é‡æ–°æ„å»ºè„šæœ¬..."
            # æ‰§è¡Œæ‚¨åœ¨ VPS ä¸Šå‡†å¤‡çš„è„šæœ¬
            # å‡è®¾è„šæœ¬åä¸º deploy.shï¼Œè¯·æ ¹æ®å®é™…è„šæœ¬åç§°ä¿®æ”¹
            if [ -f "deploy.sh" ]; then
              chmod +x deploy.sh
              ./deploy.sh           
            else
              echo "âš ï¸  æœªæ‰¾åˆ°éƒ¨ç½²è„šæœ¬ï¼Œè¯·ç¡®ä¿è„šæœ¬å­˜åœ¨"
              echo "å½“å‰ç›®å½•æ–‡ä»¶ï¼š"
              ls -la
              exit 1
            fi

            # æ¸…ç†å‹ç¼©æ–‡ä»¶
            rm -f build.zip

            echo "âœ… éƒ¨ç½²å®Œæˆï¼"

      - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "åº”ç”¨å·²éƒ¨ç½²åˆ° http://${{ secrets.REMOTE_HOST }}"
          echo "Docker å®¹å™¨æ­£åœ¨è¿è¡Œï¼Œä½¿ç”¨ Caddy æœåŠ¡å™¨æä¾› SPA æ”¯æŒ"

      - name: éƒ¨ç½²å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼è¯·æ£€æŸ¥æ„å»ºæˆ–ç½‘ç»œè¿æ¥ã€‚"
          echo "è¯·æŸ¥çœ‹ä¸Šé¢çš„æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚"
