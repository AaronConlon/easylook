name: Build Frontend and Deploy

on:
  push:
    tags:
      - '*'
    branches:
      - main
      - master
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'

jobs:
  build-and-deploy:
    # é™¤äº† tags å‘ç‰ˆä¼šæ‰§è¡Œ ci å¤–ï¼Œåœ¨ commit message ä¸­åŒ…å« run-ciï¼Œä¹Ÿä¼šæ‰§è¡Œ ci
    # ä¸»è¦æ˜¯ä¸ºäº†åœ¨ tags å¤–æ‰§è¡Œä¸€æ¬¡ ciï¼Œç¼“å­˜ node_modules ç»™ tags å…±äº«
    # å› ä¸ºå„ tags æ˜¯æ— æ³•å…±äº« node_modules çš„
    if: ${{
      github.event_name == 'push' &&
      (
      contains(github.event.head_commit.message, 'run-ci') ||
      startsWith(github.ref, 'refs/tags')
      )
      }}
    env:
      __PKG_NAME__: 'app-website'
      __PKG_VERSION_NUM__: '0.0.0'
      __PKG_VERSION_STR__: 'v0.0.0'

    # åªåœ¨æ¨é€åˆ° main åˆ†æ”¯æˆ–è€… PR åˆå¹¶åˆ° main åˆ†æ”¯æ—¶è¿è¡Œ
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'yarn'
          cache-dependency-path: './yarn.lock'

      - name: 'Get Package Version'
        run: |
          PKG_VERSION=$(echo $(node ./.github/scripts/ci-get-pkg-version.js))
          echo $PKG_VERSION
          echo __PKG_VERSION_NUM__=$PKG_VERSION >> $GITHUB_ENV
          echo __PKG_VERSION_STR__=v$PKG_VERSION >> $GITHUB_ENV
          echo __PKG_BUILD_NAME__=build-v$PKG_VERSION >> $GITHUB_ENV

      - name: å®‰è£…ä¾èµ–
        if: ${{ steps.STEP_CACHE.outputs.cache-hit != 'true' }}
        run: yarn install --frozen-lockfile

      #
      # GEN .env
      # ---------------------------------------------------------
      - name: 'Gen All Github Secrets to `.env`'
        run: |
          echo "" > .env
          echo "---- DOTENV-PLACEHOLDER-S ----"
          echo SKIP_PREFLIGHT_CHECK=${{ secrets.SKIP_PREFLIGHT_CHECK }} >> .env
          echo GENERATE_SOURCEMAP=${{ secrets.GENERATE_SOURCEMAP }} >> .env
          echo PORT=${{ secrets.PORT }} >> .env
          echo CODE_EDITOR=${{ secrets.CODE_EDITOR }} >> .env
          echo REACT_APP_NAME=${{ secrets.REACT_APP_NAME }} >> .env
          echo REACT_APP_PAGE_CNAME=${{ secrets.REACT_APP_PAGE_CNAME }} >> .env
          echo REACT_APP_API_BASE_URL=${{ secrets.REACT_APP_API_BASE_URL }} >> .env
          echo REACT_APP_CDN_URL=${{ secrets.REACT_APP_CDN_URL }} >> .env
          echo REACT_APP_UPLOAD_URL=${{ secrets.REACT_APP_UPLOAD_URL }} >> .env
          echo REACT_APP_ENABLE_AXIOS_CATCH_ERROR_MSG=${{ secrets.REACT_APP_ENABLE_AXIOS_CATCH_ERROR_MSG }} >> .env
          echo REACT_APP_ENABLE_DARK_THEME=${{ secrets.REACT_APP_ENABLE_DARK_THEME }} >> .env
          echo CI_CDN_ACCESS_KEY=${{ secrets.CI_CDN_ACCESS_KEY }} >> .env
          echo CI_CDN_SECRET_KEY=${{ secrets.CI_CDN_SECRET_KEY }} >> .env
          echo CI_CDN_BUCKET=${{ secrets.CI_CDN_BUCKET }} >> .env
          echo CI_GITHUB_TOKEN=${{ secrets.CI_GITHUB_TOKEN }} >> .env
          echo REACT_APP_DEBUG_BAR_PASSWORD_HASH=${{ secrets.REACT_APP_DEBUG_BAR_PASSWORD_HASH }} >> .env
          echo "---- DOTENV-PLACEHOLDER-E ----"
          cat .env
      

      - name: æ„å»ºå‰ç«¯é¡¹ç›®
        run: yarn build

      - name: éªŒè¯æ„å»ºäº§ç‰©
        run: |
          if [ ! -d "./build" ]; then
            echo "æ„å»ºå¤±è´¥ï¼šæ‰¾ä¸åˆ° build ç›®å½•"
            exit 1
          fi
          echo "æ„å»ºæˆåŠŸï¼Œäº§ç‰©å¤§å°ï¼š"
          du -sh ./build

      - name: å‹ç¼©æ„å»ºäº§ç‰©
        run: |
          zip -r build.zip build/
          echo "âœ… æ„å»ºäº§ç‰©å·²å‹ç¼©"
          echo "å‹ç¼©æ–‡ä»¶å¤§å°ï¼š"
          ls -lh build.zip

          # å°†å‹ç¼©æ–‡ä»¶ç§»åŠ¨åˆ°æ ¹ç›®å½•ï¼Œé¿å…ä¼ è¾“æ—¶ä¿ç•™ç›®å½•ç»“æ„
          mv build.zip ./${{ env.__PKG_BUILD_NAME__ }}.zip

      - name: æ¨é€æ„å»ºäº§ç‰©åˆ°è¿œç¨‹æœåŠ¡å™¨
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          source: './${{ env.__PKG_BUILD_NAME__ }}.zip'
          target: '${{ secrets.REMOTE_TARGET_PATH }}'
          overwrite: true

      - name: åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šéƒ¨ç½²
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            cd ${{ secrets.REMOTE_TARGET_PATH }}

            echo "åˆ é™¤æ—§çš„ build ç›®å½•"
            rm -rf build

            echo "ğŸ“¦ è§£å‹æ„å»ºäº§ç‰©..."
            unzip -o ${{ env.__PKG_BUILD_NAME__ }}.zip -d .


            echo "ğŸ³ æ‰§è¡Œ Docker é‡æ–°æ„å»ºè„šæœ¬..."
            # æ‰§è¡Œæ‚¨åœ¨ VPS ä¸Šå‡†å¤‡çš„è„šæœ¬
            # å‡è®¾è„šæœ¬åä¸º deploy.shï¼Œè¯·æ ¹æ®å®é™…è„šæœ¬åç§°ä¿®æ”¹
            if [ -f "deploy.sh" ]; then
              chmod +x deploy.sh
              ./deploy.sh           
            else
              echo "âš ï¸  æœªæ‰¾åˆ°éƒ¨ç½²è„šæœ¬ï¼Œè¯·ç¡®ä¿è„šæœ¬å­˜åœ¨"
              echo "å½“å‰ç›®å½•æ–‡ä»¶ï¼š"
              ls -la
              exit 1
            fi           

            echo "âœ… éƒ¨ç½²å®Œæˆï¼"

      - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "åº”ç”¨å·²éƒ¨ç½²åˆ° http://${{ secrets.REMOTE_HOST }}"
          echo "Docker å®¹å™¨æ­£åœ¨è¿è¡Œï¼Œä½¿ç”¨ Caddy æœåŠ¡å™¨æä¾› SPA æ”¯æŒ"

      - name: éƒ¨ç½²å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼è¯·æ£€æŸ¥æ„å»ºæˆ–ç½‘ç»œè¿æ¥ã€‚"
          echo "è¯·æŸ¥çœ‹ä¸Šé¢çš„æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚"
