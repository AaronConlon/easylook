# GitHub Actions å‰ç«¯æ„å»ºè‡ªåŠ¨éƒ¨ç½²é…ç½®è¯´æ˜

æœ¬é¡¹ç›®å·²é…ç½® GitHub Actions è‡ªåŠ¨æ„å»ºå’Œéƒ¨ç½²åŠŸèƒ½ã€‚æ¯å½“ main åˆ†æ”¯æœ‰æ–°çš„æ¨é€æˆ– PR åˆå¹¶æ—¶ï¼Œå°†è‡ªåŠ¨æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

1. æ£€å‡ºä»£ç 
2. è®¾ç½® Node.js ç¯å¢ƒ
3. å®‰è£…ä¾èµ–å¹¶æ„å»ºå‰ç«¯é¡¹ç›® (`packages/app-website`)
4. å‹ç¼©æ„å»ºäº§ç‰©ä¸º zip æ–‡ä»¶
5. é€šè¿‡ SCP å°†å‹ç¼©æ–‡ä»¶æ¨é€åˆ°è¿œç¨‹æœåŠ¡å™¨
6. åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šè§£å‹å¹¶æ‰§è¡Œé¢„è®¾çš„ Docker æ„å»ºè„šæœ¬

## ğŸ”§ å¿…éœ€çš„ GitHub Secrets é…ç½®

åœ¨ä½¿ç”¨æ­¤ Docker è‡ªåŠ¨éƒ¨ç½²åŠŸèƒ½å‰ï¼Œæ‚¨éœ€è¦åœ¨ GitHub ä»“åº“ä¸­é…ç½®ä»¥ä¸‹ Secretsï¼š

### å¿…éœ€çš„ Secretsï¼š

1. **`REMOTE_HOST`**
   - å€¼ï¼š`47.103.92.149`
   - æè¿°ï¼šè¿œç¨‹æœåŠ¡å™¨çš„ IP åœ°å€

2. **`REMOTE_USER`** 
   - å€¼ï¼š`root`
   - æè¿°ï¼šè¿œç¨‹æœåŠ¡å™¨çš„ç™»å½•ç”¨æˆ·å

3. **`SSH_PRIVATE_KEY`**
   - å€¼ï¼šSSH ç§é’¥çš„å®Œæ•´å†…å®¹
   - æè¿°ï¼šç”¨äº SSH è¿æ¥çš„ç§é’¥ï¼ˆéœ€è¦åŒ…å«å®Œæ•´çš„ç§é’¥ï¼ŒåŒ…æ‹¬å¤´å°¾ï¼‰

### å¯é€‰çš„ Secretsï¼š

4. **`REMOTE_PORT`** (å¯é€‰)
   - é»˜è®¤å€¼ï¼š`22`
   - æè¿°ï¼šSSH è¿æ¥ç«¯å£

5. **`REMOTE_TARGET_PATH`** (å¯é€‰)
   - é»˜è®¤å€¼ï¼š`/root/`
   - æè¿°ï¼šè¿œç¨‹æœåŠ¡å™¨ä¸Šç”¨äºå­˜æ”¾æ„å»ºæ–‡ä»¶å’Œæ‰§è¡Œè„šæœ¬çš„è·¯å¾„

## ğŸ“ å¦‚ä½•é…ç½® Secrets

1. è¿›å…¥æ‚¨çš„ GitHub ä»“åº“é¡µé¢
2. ç‚¹å‡» "Settings" æ ‡ç­¾é¡µ
3. åœ¨å·¦ä¾§èœå•ä¸­é€‰æ‹© "Secrets and variables" > "Actions"
4. ç‚¹å‡» "New repository secret" æŒ‰é’®
5. æ·»åŠ ä¸Šè¿°å¿…éœ€çš„ Secrets

## ğŸ” SSH å¯†é’¥é…ç½®

### 1. ç”Ÿæˆ SSH å¯†é’¥å¯¹ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰ï¼š

```bash
ssh-keygen -t ed25519 -C "github-actions@your-domain.com"
```

### 2. å°†å…¬é’¥æ·»åŠ åˆ°è¿œç¨‹æœåŠ¡å™¨ï¼š

```bash
# å°†å…¬é’¥å†…å®¹å¤åˆ¶åˆ°è¿œç¨‹æœåŠ¡å™¨çš„ authorized_keys
cat ~/.ssh/id_ed25519.pub | ssh root@47.103.92.149 "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys"
```

### 3. å°†ç§é’¥æ·»åŠ åˆ° GitHub Secretsï¼š

- å¤åˆ¶ç§é’¥çš„å®Œæ•´å†…å®¹ï¼š`cat ~/.ssh/id_ed25519`
- å°†å†…å®¹ç²˜è´´åˆ° GitHub Secrets ä¸­çš„ `SSH_PRIVATE_KEY`

## ğŸš€ éƒ¨ç½²æµç¨‹

å·¥ä½œæµå°†æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

1. **ä»£ç æ£€å‡º**ï¼šè·å–æœ€æ–°ä»£ç 
2. **ç¯å¢ƒå‡†å¤‡**ï¼šè®¾ç½® Node.js 18 ç¯å¢ƒï¼Œå¯ç”¨ Yarn ç¼“å­˜
3. **ä¾èµ–å®‰è£…**ï¼šä½¿ç”¨ `yarn install --frozen-lockfile` å®‰è£…ä¾èµ–
4. **å‰ç«¯æ„å»º**ï¼šåœ¨ `packages/app-website` ç›®å½•æ‰§è¡Œ `yarn build`
5. **äº§ç‰©éªŒè¯**ï¼šæ£€æŸ¥æ„å»ºäº§ç‰©æ˜¯å¦å­˜åœ¨
6. **æ–‡ä»¶å‹ç¼©**ï¼šå°†æ„å»ºäº§ç‰©å‹ç¼©ä¸º `build.zip`
7. **æ–‡ä»¶ä¼ è¾“**ï¼šä½¿ç”¨ SCP å°†å‹ç¼©æ–‡ä»¶æ¨é€åˆ°è¿œç¨‹æœåŠ¡å™¨
8. **è¿œç¨‹éƒ¨ç½²**ï¼šåœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šè§£å‹æ–‡ä»¶å¹¶æ‰§è¡Œé¢„è®¾çš„ sh è„šæœ¬
9. **çŠ¶æ€é€šçŸ¥**ï¼šæ˜¾ç¤ºéƒ¨ç½²æˆåŠŸæˆ–å¤±è´¥çš„æ¶ˆæ¯

## ğŸ³ VPS ç«¯ Docker æ¶æ„

- **æ„å»ºæ–¹å¼**ï¼šåœ¨ VPS ä¸Šé€šè¿‡æ‚¨é¢„è®¾çš„ sh è„šæœ¬æ„å»º Docker é•œåƒ
- **Web æœåŠ¡å™¨**ï¼šCaddy 2.xï¼ˆåœ¨æ‚¨çš„è„šæœ¬ä¸­é…ç½®ï¼‰
- **SPA æ”¯æŒ**ï¼šé€šè¿‡ Caddyfile é…ç½® `try_files` å®ç°å‰ç«¯è·¯ç”±å›é€€
- **æ„å»ºäº§ç‰©æ¥æº**ï¼šGitHub Actions æ„å»ºå¹¶ä¼ è¾“çš„å‰ç«¯æ–‡ä»¶

## ğŸ“ æ–‡ä»¶ä¼ è¾“æµç¨‹

- **GitHub Actions æ„å»º**ï¼š`./packages/app-website/build/` â†’ `build.zip`
- **SCP ä¼ è¾“**ï¼š`build.zip` â†’ `47.103.92.149:/root/` (æˆ–è‡ªå®šä¹‰è·¯å¾„)
- **VPS å¤„ç†**ï¼šè§£å‹ â†’ æ‰§è¡Œ sh è„šæœ¬ â†’ Docker é•œåƒæ„å»º â†’ å®¹å™¨è¿è¡Œ

## ğŸ“‹ VPS è„šæœ¬è¦æ±‚

GitHub Actions ä¼šåœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šå¯»æ‰¾ä»¥ä¸‹è„šæœ¬ä¹‹ä¸€ï¼š
- `rebuild-docker.sh`
- `rebuild-docker-caddy.sh`

è¯¥è„šæœ¬åº”è¯¥ï¼š
1. ä½¿ç”¨è§£å‹åçš„ `build/` ç›®å½•ä¸­çš„å‰ç«¯æ–‡ä»¶
2. æ„å»ºåŒ…å« Caddy æœåŠ¡å™¨çš„ Docker é•œåƒ
3. åœæ­¢æ—§å®¹å™¨å¹¶å¯åŠ¨æ–°å®¹å™¨
4. é…ç½® Caddy çš„ `try_files` å›é€€åˆ° `index.html`

### ç¤ºä¾‹ VPS è„šæœ¬ç»“æ„ï¼š

```bash
#!/bin/bash
# rebuild-docker.sh

# æ„å»ºæ–°çš„ Docker é•œåƒï¼ˆä½¿ç”¨å½“å‰ç›®å½•çš„ build/ æ–‡ä»¶å¤¹ï¼‰
docker build -t easylook-website:latest .

# åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
docker stop easylook-website || true
docker rm easylook-website || true

# è¿è¡Œæ–°å®¹å™¨
docker run -d \
  --name easylook-website \
  --restart unless-stopped \
  -p 80:80 \
  easylook-website:latest

echo "âœ… Docker å®¹å™¨å·²é‡æ–°éƒ¨ç½²"
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **VPS è„šæœ¬**ï¼šç¡®ä¿åœ¨ VPS ä¸Šæœ‰å¯æ‰§è¡Œçš„é‡å»ºè„šæœ¬ (`rebuild-docker.sh` æˆ– `rebuild-docker-caddy.sh`)
2. **Docker ç¯å¢ƒ**ï¼šç¡®ä¿è¿œç¨‹æœåŠ¡å™¨å·²å®‰è£… Docker å¹¶æ­£åœ¨è¿è¡Œ
3. **æƒé™æ£€æŸ¥**ï¼šç¡®ä¿è¿œç¨‹æœåŠ¡å™¨çš„ç›®æ ‡ç›®å½•æœ‰å†™å…¥æƒé™
4. **ç½‘ç»œè¿é€šæ€§**ï¼šç¡®ä¿ GitHub Actions runner èƒ½å¤Ÿè®¿é—®ç›®æ ‡æœåŠ¡å™¨
5. **SSH é…ç½®**ï¼šç¡®ä¿ SSH å¯†é’¥é…ç½®æ­£ç¡®ï¼Œå¯ä»¥æ— å¯†ç ç™»å½•
6. **ç«¯å£å ç”¨**ï¼šç¡®ä¿è¿œç¨‹æœåŠ¡å™¨çš„ 80 ç«¯å£å¯ç”¨ï¼Œæˆ–ä¿®æ”¹ç«¯å£æ˜ å°„
7. **æ„å»ºä¾èµ–**ï¼šç¡®ä¿ `packages/app-website` ç›®å½•ä¸‹çš„ `package.json` åŒ…å« `build` è„šæœ¬

## ğŸ› æ•…éšœæ’é™¤

å¦‚æœéƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥ï¼š

1. **GitHub Secrets** æ˜¯å¦æ­£ç¡®é…ç½®
2. **SSH å¯†é’¥** æ˜¯å¦æœ‰æ•ˆ
3. **è¿œç¨‹æœåŠ¡å™¨** æ˜¯å¦å¯è®¿é—®
4. **Docker æœåŠ¡** æ˜¯å¦åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šè¿è¡Œ
5. **ç«¯å£å†²çª** æ£€æŸ¥ 80 ç«¯å£æ˜¯å¦è¢«å ç”¨
6. **æƒé™é—®é¢˜** ç›®æ ‡è·¯å¾„æ˜¯å¦æœ‰å†™å…¥æƒé™
7. **é•œåƒå¤§å°** ç¡®ä¿ç£ç›˜ç©ºé—´è¶³å¤Ÿå­˜å‚¨ Docker é•œåƒ

### å¸¸ç”¨è°ƒè¯•å‘½ä»¤

åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šæ£€æŸ¥å®¹å™¨çŠ¶æ€ï¼š
```bash
# æŸ¥çœ‹è¿è¡Œä¸­çš„å®¹å™¨
docker ps

# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs easylook-website

# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨ï¼ˆåŒ…æ‹¬åœæ­¢çš„ï¼‰
docker ps -a

# æŸ¥çœ‹ Docker é•œåƒ
docker images
```

æŸ¥çœ‹ GitHub Actions æ—¥å¿—å¯ä»¥è·å–è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ã€‚

## ğŸ”„ æ‰‹åŠ¨éƒ¨ç½²

å¦‚éœ€æ‰‹åŠ¨éƒ¨ç½²ï¼Œå¯ä»¥åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

```bash
# åœæ­¢æ—§å®¹å™¨
docker stop easylook-website
docker rm easylook-website

# è¿è¡Œæ–°å®¹å™¨
docker run -d \
  --name easylook-website \
  --restart unless-stopped \
  -p 80:80 \
  easylook-website:latest
```
